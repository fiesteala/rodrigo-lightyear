<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cumple Buzz Rodrigo 1 A√±o</title>
    
    <!-- === METADATOS PARA WHATSAPP Y REDES === -->
    <meta property="og:title" content="üöÄ MISI√ìN CUMPLIDA: Gracias por venir">
    <meta property="og:description" content="¬°Misi√≥n Cumplida! Gracias por asistir. Te invitamos a ver la galer√≠a de la fiesta y la sesi√≥n de fotos del Cadete Rodrigo. üöÄüì∏">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fiesteala.github.io/rodrigo-lightyear/">
    <meta property="og:image" content="https://github.com/fiesteala/rodrigo-lightyear/blob/main/IMG_0611.png?raw=true">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/png">
    
    <!-- Metadatos adicionales para asegurar compatibilidad -->
    <meta itemprop="name" content="Misi√≥n Cumplida: Rodrigo">
    <meta itemprop="description" content="¬°Misi√≥n Cumplida! Gracias por asistir. Te invitamos a ver la galer√≠a de la fiesta y la sesi√≥n de fotos del Cadete Rodrigo. üöÄüì∏">
    <meta itemprop="image" content="https://github.com/fiesteala/rodrigo-lightyear/blob/main/IMG_0611.png?raw=true">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="üöÄ MISI√ìN CUMPLIDA: Gracias por venir">
    <meta name="twitter:description" content="¬°Misi√≥n Cumplida! Gracias por asistir. Te invitamos a ver la galer√≠a de la fiesta y la sesi√≥n de fotos del Cadete Rodrigo. üöÄüì∏">
    <meta name="twitter:image" content="https://github.com/fiesteala/rodrigo-lightyear/blob/main/IMG_0611.png?raw=true">

    <!-- Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <!-- SortableJS para arrastrar y soltar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>

    <style>
        :root {
            --buzz-green: #74c045;
            --buzz-purple: #6b3fa0;
            --buzz-white: #ffffff;
            --buzz-red: #da2c38;
            --space-dark: #0f172a;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--space-dark);
            color: var(--buzz-white);
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .font-space { font-family: 'Orbitron', sans-serif; }

        /* Estrellas */
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }
        .star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite; opacity: 0;
        }
        @keyframes twinkle {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 0.8; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0.5); }
        }

        /* Botones Buzz */
        .btn-buzz {
            background: linear-gradient(to bottom, #8ede5d, #74c045);
            border-bottom: 4px solid #4a8a2a;
            transition: all 0.1s;
        }
        .btn-buzz:active { transform: translateY(2px); border-bottom: 2px solid #4a8a2a; }

        .scan-line {
            width: 100%; height: 4px; background: #74c045;
            box-shadow: 0 0 10px #74c045; animation: scan 2s linear infinite; opacity: 0.7;
        }
        @keyframes scan { 0% { transform: translateY(-100vh); } 100% { transform: translateY(100vh); } }

        .hidden-content { display: none; opacity: 0; transition: opacity 0.5s ease-in; }

        .card-border {
            border: 2px solid var(--buzz-green);
            box-shadow: 0 0 15px rgba(116, 192, 69, 0.4);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .wing-pattern {
            background-image: repeating-linear-gradient(45deg, var(--buzz-red), var(--buzz-red) 10px, var(--buzz-white) 10px, var(--buzz-white) 20px);
        }

        /* Galer√≠a Masonry */
        .masonry-grid {
            column-count: 2; column-gap: 1rem;
        }
        @media (min-width: 768px) { .masonry-grid { column-count: 3; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 4; } }

        .gallery-item {
            break-inside: avoid; margin-bottom: 1rem; border-radius: 0.75rem;
            overflow: hidden; position: relative; transform: translateZ(0);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            background: #fff; cursor: zoom-in;
        }
        
        .gallery-item:hover, .gallery-item:active {
            transform: scale(1.05) rotate(var(--rotation)); z-index: 20;
            border-color: var(--buzz-green); box-shadow: 0 10px 20px rgba(116, 192, 69, 0.5);
        }
        .gallery-item img { width: 100%; height: auto; display: block; }

        /* Modal Admin */
        .admin-modal { backdrop-filter: blur(10px); background: rgba(15, 23, 42, 0.95); }
        
        /* Pesta√±as Admin */
        .tab-btn.active {
            border-bottom: 2px solid #74c045;
            color: #74c045;
            background-color: rgba(116, 192, 69, 0.1);
        }

        /* Estilos para Drag & Drop y Selecci√≥n en Admin */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #4b5563;
            border: 2px dashed #74c045;
        }
        .admin-photo-item {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .admin-photo-item:active { cursor: grabbing; }
        .admin-photo-item.selected {
            border: 3px solid #ef4444;
            transform: scale(0.95);
            opacity: 0.9;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .admin-photo-item.selected::after {
            content: '‚úì'; position: absolute; top: 5px; right: 5px;
            background: #ef4444; color: white; width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; z-index: 10;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center relative">

    <div id="stars-container" class="stars"></div>
    <audio id="bg-music" loop>
        <source src="https://github.com/fiesteala/rodrigo-lightyear/raw/refs/heads/main/Buzz.mp3">
    </audio>

    <!-- INTRO -->
    <div id="intro-screen" class="flex flex-col items-center justify-center w-full h-full p-6 text-center z-10 transition-all duration-700">
        <div class="animate-pulse mb-6">
            <div class="w-24 h-24 rounded-full border-4 border-green-500 flex items-center justify-center bg-gray-800 shadow-[0_0_20px_rgba(116,192,69,0.6)]">
                <i data-lucide="award" class="w-12 h-12 text-yellow-400"></i>
            </div>
        </div>
        <h1 class="font-space text-3xl text-green-400 mb-2 tracking-widest uppercase font-bold">Misi√≥n Cumplida</h1>
        <p class="text-blue-200 text-lg mb-8 animate-bounce">Reporte Final Disponible...</p>
        <div class="w-full max-w-xs bg-gray-800 rounded-lg p-4 border border-green-600 relative overflow-hidden group cursor-pointer" onclick="window.openInvitation()">
            <div class="scan-line absolute top-0 left-0"></div>
            <p class="font-space text-xl text-white font-bold uppercase tracking-wider">VER MENSAJE</p>
            <p class="text-xs text-green-400 mt-1">Autorizaci√≥n Concedida</p>
        </div>
    </div>

    <!-- MAIN -->
    <div id="main-content" class="hidden-content w-full h-full absolute top-0 left-0 overflow-y-auto z-20 pb-10">
        <div class="w-full h-16 bg-white flex items-center justify-between px-4 shadow-lg sticky top-0 z-30">
            <div class="flex gap-2">
                <div class="w-4 h-4 rounded-full bg-red-500 shadow-md"></div>
                <div class="w-4 h-4 rounded-full bg-green-500 shadow-md"></div>
                <div class="w-4 h-4 rounded-full bg-blue-500 shadow-md"></div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.toggleMusic()" id="music-btn" class="w-8 h-8 rounded-full border-2 border-purple-800 flex items-center justify-center text-purple-800 bg-white active:scale-90 transition-transform">
                    <i id="music-icon" data-lucide="volume-2" class="w-4 h-4"></i>
                </button>
                <div class="text-purple-800 font-bold font-space text-xs tracking-widest border-2 border-purple-800 px-2 rounded">STAR COMMAND</div>
            </div>
        </div>

        <div class="p-5 flex flex-col items-center max-w-md mx-auto mt-4">
            <div class="relative w-full mb-6 text-center">
                <div class="wing-pattern h-4 w-full absolute top-1/2 -z-10 rounded"></div>
                <div class="inline-block bg-purple-700 p-4 rounded-full border-4 border-white shadow-xl relative z-10">
                    <i data-lucide="user-astronaut" class="w-16 h-16 text-white"></i>
                </div>
            </div>

            <!-- T√çTULO -->
            <div class="text-center mb-6">
                <h2 class="font-space text-green-400 text-sm uppercase tracking-widest mb-1">REPORTE DE MISI√ìN</h2>
                <h1 class="font-space text-4xl font-black text-white italic" style="text-shadow: 3px 3px 0px #6b3fa0;">
                    RODRIGO
                    <span class="block text-xl text-purple-400 mt-1">¬°TE DICE GRACIAS!</span>
                </h1>
            </div>

            <div class="card-border rounded-xl p-6 w-full text-center bg-gray-900/80 mb-6 backdrop-blur-md">
                <div class="mb-4">
                    <i data-lucide="stars" class="w-8 h-8 text-yellow-400 mx-auto mb-2"></i>
                    <p class="text-white text-lg font-bold font-space mb-2">Misi√≥n Exitosa</p>
                </div>
                <p class="text-gray-300 text-base leading-relaxed mb-4">
                    ¬°Gracias infinitas por acompa√±arme en mi primer viaje alrededor del sol! 
                    <br><br>
                    Tu cari√±o, tus sonrisas y tu compa√±√≠a hicieron que mi primera misi√≥n fuera verdaderamente m√°gica. ¬°Tenerte en mi tripulaci√≥n ha sido el regalo m√°s especial de la galaxia!
                </p>
                <div class="w-full h-px bg-green-500/30 my-4"></div>
                <p class="text-green-400 font-space text-sm">ESTADO: <span class="text-white">FELICIDAD M√ÅXIMA</span></p>
            </div>

            <div class="w-full space-y-3">
                <!-- Bot√≥n Optimizado -->
                <button onclick="window.openGallery()" class="btn-buzz w-full py-3 sm:py-4 px-2 rounded-xl text-white font-space font-bold text-sm sm:text-lg shadow-lg flex items-center justify-center gap-2 decoration-0 active:scale-95 transition-transform whitespace-nowrap">
                    <i data-lucide="images" class="w-5 h-5"></i> VER EVIDENCIA FOTOGR√ÅFICA
                </button>
                <div class="text-center p-2">
                    <p class="text-purple-300 text-xs italic">"Las fotos est√°n clasificadas como Top Secret"</p>
                </div>
            </div>
            
            <p class="mt-8 text-xs text-gray-500 text-center font-space">"NOS VEMOS EN LA PR√ìXIMA MISI√ìN..."</p>

            <div class="w-full mt-10 mb-4 flex justify-center items-center gap-2 opacity-40 hover:opacity-100 transition-opacity">
                <p class="text-[10px] font-space text-gray-400 tracking-widest uppercase">Fiesteala &reg;</p>
                <button onclick="window.openAdminModal()" class="text-gray-400 hover:text-white p-1 transition-transform active:scale-90"><i data-lucide="lock" class="w-3 h-3"></i></button>
            </div>
        </div>
    </div>

    <!-- GALER√çA -->
    <div id="gallery-screen" class="hidden-content w-full h-full absolute top-0 left-0 overflow-y-auto z-40 pb-10" style="background-color: rgba(15, 23, 42, 0.98);">
        <div class="w-full h-16 bg-gray-900/80 backdrop-blur flex items-center justify-between px-4 sticky top-0 z-50 border-b border-green-500/30">
            <button onclick="window.closeGallery()" class="text-white p-2 rounded-full hover:bg-gray-800 transition active:scale-90">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-space text-green-400 text-lg tracking-widest">GALER√çA</h2>
            <div class="w-8"></div>
        </div>
        <div class="p-4">
            <div id="loading-spinner" class="text-center mt-10 text-green-500">
                <i data-lucide="loader-2" class="animate-spin w-8 h-8 mx-auto"></i>
                <p class="text-xs mt-2">Cargando...</p>
            </div>
            
            <div id="config-error-msg" class="hidden text-center mt-10 p-6 bg-red-900/80 rounded-lg border border-red-500 mx-4">
                <i data-lucide="alert-triangle" class="mx-auto w-10 h-10 text-red-400 mb-2"></i>
                <h3 class="text-white font-bold mb-2">ACCESO DENEGADO</h3>
                <p class="text-xs text-red-200 mb-4">No tienes permiso para ver los datos.</p>
                <div class="text-[10px] text-gray-400 bg-black/50 p-2 rounded text-left">
                    <p class="font-bold">SOLUCI√ìN PARA EL DUE√ëO:</p>
                    <ol class="list-decimal pl-4 mt-1 space-y-1">
                        <li>Ve a tu <b>Consola de Firebase</b>.</li>
                        <li>Entra a <b>Firestore Database</b> > Pesta√±a <b>Reglas</b>.</li>
                        <li>Cambia <code>allow read, write: if false;</code> por <code>allow read, write: if true;</code></li>
                        <li>Dale al bot√≥n <b>Publicar</b>.</li>
                    </ol>
                </div>
            </div>

            <div id="masonry-container" class="masonry-grid"></div>
            
            <div id="empty-gallery-msg" class="hidden text-center mt-10 text-gray-400">
                <i data-lucide="image-off" class="mx-auto w-12 h-12 mb-2 opacity-50"></i>
                <p>Sin evidencia fotogr√°fica.</p>
                <p class="text-xs mt-1">Sube fotos usando el candado en el inicio.</p>
            </div>

            <div class="mt-10 text-center">
                <button onclick="window.closeGallery()" class="text-green-400 border border-green-400 px-6 py-2 rounded-full text-xs hover:bg-green-400 hover:text-black transition">VOLVER A LA BASE</button>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="fixed inset-0 z-50 bg-black hidden flex items-center justify-center opacity-0 transition-opacity duration-300" onclick="window.closeLightbox()">
        <button class="absolute top-4 right-4 text-white p-4 z-50"><i data-lucide="x" class="w-8 h-8"></i></button>
        <img id="lightbox-img" src="" class="max-w-full max-h-screen object-contain p-2 transition-transform duration-300 scale-95" alt="Foto Full">
        
        <a id="download-btn" href="#" target="_blank" onclick="event.stopPropagation(); window.trackDownload(window.currentPhotoId)" class="absolute bottom-8 bg-green-600 text-white px-6 py-3 rounded-full flex items-center gap-2 shadow-lg hover:bg-green-500 transition">
            <i data-lucide="download" class="w-4 h-4"></i> Descargar
        </a>
    </div>

    <!-- MODAL DE ADMINISTRACI√ìN COMPLETO -->
    <div id="admin-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 admin-modal">
        <div class="bg-gray-800 border-2 border-green-500 rounded-xl w-full max-w-2xl max-h-[90vh] relative shadow-2xl flex flex-col">
            
            <!-- Header Modal -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900/50 rounded-t-xl">
                <h3 class="font-space text-green-400 text-lg font-bold">PANEL DE COMANDO</h3>
                <button onclick="window.closeAdminModal()" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <!-- Login -->
            <div id="login-section" class="p-8 text-center">
                <p class="text-sm text-gray-300 mb-4">√Årea restringida. Ingresa credenciales.</p>
                <input type="password" id="admin-pass" placeholder="Contrase√±a de Mando" class="w-full max-w-xs bg-gray-900 text-white border border-gray-600 rounded p-2 text-center font-space focus:border-green-500 outline-none mb-3 mx-auto block">
                <button onclick="window.checkAdmin()" class="w-full max-w-xs bg-green-600 text-white font-bold py-2 rounded hover:bg-green-500 transition mx-auto block">ACCEDER</button>
            </div>

            <!-- Panel de Control -->
            <div id="admin-content" class="hidden flex-1 flex flex-col overflow-hidden">
                <!-- Estad√≠sticas R√°pidas -->
                <div class="bg-gray-900/50 p-2 flex justify-around border-b border-gray-700 text-xs">
                    <div class="text-center">
                        <p class="text-gray-400">Visitas Galer√≠a</p>
                        <p class="text-green-400 font-bold text-sm" id="stat-gallery-views">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400">Invitados</p>
                        <p class="text-blue-400 font-bold text-sm" id="stat-guests-count">0</p>
                    </div>
                </div>

                <!-- Pesta√±as -->
                <div class="flex border-b border-gray-700 bg-gray-900/30 overflow-x-auto">
                    <button onclick="window.switchTab('upload')" id="tab-upload" class="tab-btn active flex-1 py-3 px-2 text-center text-xs font-space text-gray-400 hover:text-white transition whitespace-nowrap">SUBIR</button>
                    <button onclick="window.switchTab('edit')" id="tab-edit" class="tab-btn flex-1 py-3 px-2 text-center text-xs font-space text-gray-400 hover:text-white transition whitespace-nowrap">EDITAR</button>
                    <button onclick="window.switchTab('guests')" id="tab-guests" class="tab-btn flex-1 py-3 px-2 text-center text-xs font-space text-gray-400 hover:text-white transition whitespace-nowrap">INVITADOS</button>
                </div>

                <!-- Contenido Pesta√±as -->
                <div class="flex-1 overflow-y-auto p-4">
                    
                    <!-- SECCI√ìN SUBIR -->
                    <div id="section-upload" class="space-y-4">
                        <label class="block w-full p-8 border-2 border-dashed border-gray-600 rounded-lg text-center cursor-pointer hover:border-green-500 transition bg-gray-900/50">
                            <i data-lucide="images" class="mx-auto w-12 h-12 text-gray-400 mb-2"></i>
                            <span class="text-sm text-gray-300 block font-bold">Toca para seleccionar fotos</span>
                            <input type="file" id="file-input" accept="image/*" multiple class="hidden" onchange="window.handleFileSelect()">
                        </label>
                        <div id="upload-queue" class="text-xs text-gray-400 space-y-1 max-h-32 overflow-y-auto hidden"></div>
                        <div id="upload-progress-container" class="hidden w-full bg-gray-700 rounded-full h-4 relative overflow-hidden">
                            <div id="upload-progress" class="bg-green-500 h-full transition-all duration-300" style="width: 0%"></div>
                            <span id="progress-text" class="absolute inset-0 flex items-center justify-center text-[10px] text-white font-bold shadow-black drop-shadow-md">0%</span>
                        </div>
                        <button onclick="window.uploadPhotos()" id="upload-btn" class="w-full bg-purple-600 text-white font-bold py-3 rounded hover:bg-purple-500 transition disabled:opacity-50 disabled:cursor-not-allowed hidden">INICIAR CARGA MASIVA</button>
                    </div>

                    <!-- SECCI√ìN EDITAR -->
                    <div id="section-edit" class="hidden flex flex-col h-full">
                        <div class="flex justify-between items-center mb-3 px-1 sticky top-0 bg-gray-800 z-10 py-2 border-b border-gray-700">
                            <div class="flex gap-2">
                                <button id="btn-select-all" onclick="window.selectAll()" class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1 hover:bg-blue-500 transition" title="Seleccionar Todo"><i data-lucide="check-square" class="w-3 h-3"></i> Todo</button>
                                <button id="btn-deselect-all" onclick="window.clearSelection()" class="hidden bg-gray-600 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1 hover:bg-gray-500 transition" title="Deseleccionar"><i data-lucide="x" class="w-3 h-3"></i></button>
                                <button id="btn-delete-selected" onclick="window.deleteSelectedPhotos()" class="hidden bg-red-600 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1 hover:bg-red-500 transition shadow-lg animate-pulse"><i data-lucide="trash-2" class="w-3 h-3"></i> Borrar (<span id="selected-count">0</span>)</button>
                            </div>
                        </div>
                        <div id="admin-gallery-list" class="grid grid-cols-3 sm:grid-cols-4 gap-2 pb-4"></div>
                    </div>

                    <!-- SECCI√ìN INVITADOS (NUEVA) -->
                    <div id="section-guests" class="hidden space-y-4">
                        <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-sm text-green-400 font-bold mb-3 flex items-center gap-2"><i data-lucide="user-plus" class="w-4 h-4"></i> Nuevo Invitado</h4>
                            <div class="space-y-2">
                                <input type="text" id="guest-name" placeholder="Nombre / Familia" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white">
                                <input type="tel" id="guest-phone" placeholder="Celular (con lada)" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white">
                                <button onclick="window.addGuest()" class="w-full bg-blue-600 text-white text-sm font-bold py-2 rounded hover:bg-blue-500">AGREGAR Y ENVIAR</button>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-xs text-gray-400 uppercase tracking-widest mb-2">Lista de Tripulaci√≥n</h4>
                            <div id="guests-list" class="space-y-2"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, deleteDoc, doc, updateDoc, writeBatch, increment, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- CONFIGURACI√ìN PERSONAL ---
        const myConfig = {
            apiKey: "AIzaSyDL9UEEvWKYE7QpctYrnu1rG644x05_4Wk",
            authDomain: "bodasofiayalejadro.firebaseapp.com",
            projectId: "bodasofiayalejadro",
            storageBucket: "bodasofiayalejadro.firebasestorage.app",
            messagingSenderId: "905632324437",
            appId: "1:905632324437:web:b7aead724b299cc3202ddc"
        };

        // --- SISTEMA DE DETECCI√ìN DE CONFIGURACI√ìN ---
        let firebaseConfig;
        let appId = 'cumple-buzz-rodrigo-1-ano';
        
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                if (typeof __app_id !== 'undefined') appId = __app_id;
            } else {
                firebaseConfig = myConfig;
            }
        } catch (e) {
            firebaseConfig = myConfig;
        }

        // --- INICIALIZACI√ìN ---
        let app, db, auth;
        let photosRef, guestsRef, analyticsRef;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // --- INICIO ROBUSTO: Esperar Auth antes de cargar datos ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    initDataRefs();
                    loadAllData();
                } else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        signInWithCustomToken(auth, __initial_auth_token).catch(handleAuthError);
                    } else {
                        signInAnonymously(auth).catch(handleAuthError);
                    }
                }
            });

        } catch (e) {
            console.error("Error cr√≠tico:", e);
            handleAuthError(e);
        }

        function initDataRefs() {
            photosRef = collection(db, 'artifacts', appId, 'public', 'data', 'gallery_images');
            guestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'guest_list');
            analyticsRef = doc(db, 'artifacts', appId, 'public', 'data', 'analytics_global', 'summary');
        }

        function handleAuthError(e) {
            console.error("Auth Fallida:", e);
            const spinner = document.getElementById('loading-spinner');
            const errorMsg = document.getElementById('config-error-msg');
            if(spinner) spinner.style.display = 'none';
            if(errorMsg) errorMsg.classList.remove('hidden');
        }

        // Variables globales
        window.allPhotos = [];
        window.selectedPhotoIds = new Set();
        window.currentPhotoId = null;

        function loadAllData() {
            loadPhotos();
            loadGuests();
            loadAnalytics();
        }

        // --- GESTI√ìN DE FOTOS ---
        function loadPhotos() {
            if(!photosRef) return;
            onSnapshot(photosRef, (snapshot) => {
                let photos = [];
                snapshot.forEach(doc => photos.push({ id: doc.id, ...doc.data() }));
                
                photos.sort((a, b) => {
                    const orderA = a.order !== undefined ? a.order : 9999;
                    const orderB = b.order !== undefined ? b.order : 9999;
                    if (orderA !== orderB) return orderA - orderB;
                    return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
                });

                window.allPhotos = photos; 
                renderPublicGallery(photos);
                if (window.isAdminLoggedIn) renderAdminGallery(photos);
            }, (error) => {
                if (error.code === 'permission-denied') handleAuthError(error);
            });
        }

        // --- GESTI√ìN DE INVITADOS ---
        function loadGuests() {
            if(!guestsRef) return;
            onSnapshot(guestsRef, (snapshot) => {
                const list = document.getElementById('guests-list');
                const countStat = document.getElementById('stat-guests-count');
                if(!list) return;

                let guests = [];
                snapshot.forEach(doc => guests.push({ id: doc.id, ...doc.data() }));
                guests.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 

                if(countStat) countStat.innerText = guests.length;

                let html = '';
                guests.forEach(g => {
                    html += `
                        <div class="bg-gray-800 p-3 rounded border border-gray-700 flex justify-between items-center mb-2">
                            <div class="overflow-hidden mr-2">
                                <p class="text-white text-sm font-bold truncate">${g.name}</p>
                                <p class="text-xs text-gray-400">${g.phone} ‚Ä¢ Env√≠os: ${g.sentCount || 0}</p>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                <button onclick="window.sendWhatsapp('${g.id}', '${g.phone}', '${g.name}')" class="bg-green-600 text-white p-2 rounded-full hover:bg-green-500 transition shadow-lg active:scale-95" title="Reenviar WhatsApp">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.deleteGuest('${g.id}')" class="bg-red-600 text-white p-2 rounded-full hover:bg-red-500 transition shadow-lg active:scale-95" title="Eliminar Invitado">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html || '<p class="text-gray-500 text-center text-xs">Sin invitados a√∫n.</p>';
                lucide.createIcons();
            });
        }

        function loadAnalytics() {
            if(!analyticsRef) return;
            onSnapshot(analyticsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const viewEl = document.getElementById('stat-gallery-views');
                    if(viewEl) viewEl.innerText = data.gallery_views || 0;
                }
            });
        }

        // --- GLOBAL WINDOW FUNCTIONS ---
        
        window.openInvitation = function() {
            document.getElementById('intro-screen').style.display = 'none';
            const main = document.getElementById('main-content');
            main.style.display = 'block';
            setTimeout(() => main.style.opacity = '1', 50);
            launchConfetti();
            document.getElementById('bg-music').play().catch(()=>{});
        }

        window.toggleMusic = function() {
            const audio = document.getElementById('bg-music');
            const icon = document.getElementById('music-icon');
            if (audio.paused) {
                audio.play();
                icon.setAttribute('data-lucide', 'volume-2');
            } else {
                audio.pause();
                icon.setAttribute('data-lucide', 'volume-x');
            }
            lucide.createIcons();
        }

        window.openGallery = function() {
            if(window.trackGalleryView) window.trackGalleryView();
            document.getElementById('main-content').style.display = 'none';
            const gal = document.getElementById('gallery-screen');
            gal.style.display = 'block';
            setTimeout(() => gal.style.opacity = '1', 50);
        }

        window.closeGallery = function() {
            const gal = document.getElementById('gallery-screen');
            gal.style.opacity = '0';
            setTimeout(() => {
                gal.style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }, 300);
        }

        window.openLightbox = function(url, id) {
            if(window.trackPhotoView && id) window.trackPhotoView(id);
            const lb = document.getElementById('lightbox');
            document.getElementById('lightbox-img').src = url;
            const dlBtn = document.getElementById('download-btn');
            dlBtn.href = url;
            dlBtn.download = `foto_rodrigo_${id}.jpg`;
            lb.classList.remove('hidden');
            setTimeout(() => {
                lb.classList.remove('opacity-0');
                document.getElementById('lightbox-img').classList.remove('scale-95');
            }, 10);
        }

        window.closeLightbox = function() {
            const lb = document.getElementById('lightbox');
            lb.classList.add('opacity-0');
            document.getElementById('lightbox-img').classList.add('scale-95');
            setTimeout(() => lb.classList.add('hidden'), 300);
        }

        window.openAdminModal = function() { 
            document.getElementById('admin-modal').classList.remove('hidden'); 
            if(window.isAdminLoggedIn) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                if(window.allPhotos) renderAdminGallery(window.allPhotos);
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('admin-content').classList.add('hidden');
            }
            document.getElementById('admin-pass').value = '';
            document.getElementById('admin-pass').focus(); 
        }
        
        window.closeAdminModal = function() { 
            document.getElementById('admin-modal').classList.add('hidden'); 
        }
        
        window.checkAdmin = function() {
            const passInput = document.getElementById('admin-pass');
            if(passInput.value.trim() === 'BUZZ') {
                window.isAdminLoggedIn = true;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                if(window.allPhotos) renderAdminGallery(window.allPhotos);
            } else {
                alert("Contrase√±a incorrecta.");
            }
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-green-400', 'border-b-2', 'border-green-400'));
            document.getElementById(`tab-${tab}`).classList.add('active', 'text-green-400', 'border-b-2', 'border-green-400');
            
            document.getElementById('section-upload').classList.add('hidden');
            document.getElementById('section-edit').classList.add('hidden');
            document.getElementById('section-guests').classList.add('hidden');
            document.getElementById(`section-${tab}`).classList.remove('hidden');
        }

        // --- TRACKING FUNCTIONS ---
        window.trackGalleryView = async function() {
            try {
                if(!analyticsRef) return;
                await setDoc(analyticsRef, { gallery_views: increment(1) }, { merge: true });
            } catch(e) {}
        }

        window.trackPhotoView = async function(id) {
            if(!id || !photosRef) return;
            window.currentPhotoId = id; 
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'gallery_images', id);
            updateDoc(ref, { views: increment(1) });
        }

        window.trackDownload = async function(id) {
            if(!id || !photosRef) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'gallery_images', id);
            updateDoc(ref, { downloads: increment(1) });
        }

        // --- GUEST FUNCTIONS ---
        window.addGuest = async function() {
            const nameIn = document.getElementById('guest-name');
            const phoneIn = document.getElementById('guest-phone');
            const name = nameIn.value.trim();
            let phone = phoneIn.value.trim().replace(/\D/g,''); 

            if(!name || !phone) return alert("Nombre y celular requeridos");

            // --- ESTRATEGIA INMEDIATA PARA M√ìVIL ---
            // 1. Definir datos
            const docRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'guest_list'));
            const newId = docRef.id;
            
            // 2. Disparar guardado en background (NO AWAIT)
            setDoc(docRef, {
                name: name,
                phone: phone,
                sentCount: 1,
                timestamp: serverTimestamp()
            }).catch(e => console.error("Error guardando guest:", e));

            // 3. Abrir WhatsApp INMEDIATAMENTE (bypasea popup blockers)
            window.sendWhatsapp(newId, phone, name);
            
            // 4. Limpiar UI
            nameIn.value = '';
            phoneIn.value = '';
        }

        window.sendWhatsapp = async function(guestId, phone, name) {
            const link = window.location.href; 
            const message = `¬°Hola ${name}! üöÄ\nEl Cadete Rodrigo te invita a ver la galer√≠a de fotos de su misi√≥n de cumplea√±os.\n\nAccede aqu√≠: ${link}`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            
            // Actualizar conteo en background
            if(guestId) {
                const guestDoc = doc(db, 'artifacts', appId, 'public', 'data', 'guest_list', guestId);
                updateDoc(guestDoc, { sentCount: increment(1) }).catch(()=>{});
            }

            // Usar window.open directo
            window.open(url, '_blank');
        }

        window.deleteGuest = async function(guestId) {
            if(confirm("¬øEliminar este invitado de la lista?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'guest_list', guestId));
                } catch(e) {
                    console.error(e);
                    alert("Error al eliminar.");
                }
            }
        }

        // --- UI HELPERS ---
        function renderPublicGallery(photos) {
            const container = document.getElementById('masonry-container');
            const spinner = document.getElementById('loading-spinner');
            const emptyMsg = document.getElementById('empty-gallery-msg');
            const errorMsg = document.getElementById('config-error-msg');
            
            if (!errorMsg.classList.contains('hidden')) return;

            if (spinner) spinner.style.display = 'none';
            if (photos.length === 0) {
                if (emptyMsg) emptyMsg.classList.remove('hidden');
                if (container) container.innerHTML = '';
                return;
            }
            if (emptyMsg) emptyMsg.classList.add('hidden');

            let html = '';
            photos.forEach((p, i) => {
                const rot = (Math.random() * 4 - 2).toFixed(1) + 'deg';
                const delay = i * 50; 
                html += `
                    <div class="gallery-item animate-[fadeIn_0.5s_ease-out_forwards]" 
                         style="--rotation: ${rot}; animation-delay: ${delay}ms"
                         onclick="window.openLightbox('${p.url}', '${p.id}')">
                        <img src="${p.url}" loading="lazy" alt="Recuerdo">
                    </div>
                `;
            });
            if (container) {
                container.innerHTML = html;
                lucide.createIcons();
            }
        }

        function renderAdminGallery(photos) {
            const container = document.getElementById('admin-gallery-list');
            if(!container) return; 

            if(photos.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No hay fotos. Sube algunas primero.</div>';
                return;
            }

            container.innerHTML = ''; 

            photos.forEach(p => {
                const isSelected = window.selectedPhotoIds.has(p.id);
                const el = document.createElement('div');
                el.className = `admin-photo-item bg-gray-900 rounded border border-gray-700 overflow-hidden relative ${isSelected ? 'selected' : ''}`;
                el.dataset.id = p.id; 
                
                const views = p.views || 0;
                const dls = p.downloads || 0;

                el.innerHTML = `
                    <img src="${p.url}" class="w-full h-24 object-cover pointer-events-none">
                    <div class="absolute inset-0 bg-black/0 hover:bg-black/20 transition"></div>
                    <div class="absolute bottom-0 left-0 right-0 bg-black/70 p-1 flex justify-between text-[10px] text-gray-300">
                        <span class="flex items-center gap-1"><i data-lucide="eye" class="w-3 h-3"></i> ${views}</span>
                        <span class="flex items-center gap-1"><i data-lucide="download" class="w-3 h-3"></i> ${dls}</span>
                    </div>
                `;
                
                el.onclick = () => window.togglePhotoSelection(p.id, el);
                container.appendChild(el);
            });

            if (!window.sortableInstance) {
                window.sortableInstance = new Sortable(container, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async function (evt) {
                        const draggedId = evt.item.dataset.id;
                        if (window.selectedPhotoIds.has(draggedId) && window.selectedPhotoIds.size > 1) {
                            const allItems = Array.from(container.children);
                            const draggedEl = evt.item;
                            const selectedElements = allItems.filter(el => 
                                window.selectedPhotoIds.has(el.dataset.id) && el !== draggedEl
                            );
                            selectedElements.forEach(el => draggedEl.after(el));
                        }
                        await saveNewOrder();
                    }
                });
            }
            lucide.createIcons();
        }

        // --- ADMIN ACTIONS ---
        window.togglePhotoSelection = function(id, element) {
            if (window.selectedPhotoIds.has(id)) {
                window.selectedPhotoIds.delete(id);
                element.classList.remove('selected');
            } else {
                window.selectedPhotoIds.add(id);
                element.classList.add('selected');
            }
            updateDeleteButton();
        }

        window.clearSelection = function() {
            window.selectedPhotoIds.clear();
            const items = document.querySelectorAll('.admin-photo-item');
            items.forEach(el => el.classList.remove('selected'));
            updateDeleteButton();
        }

        window.selectAll = function() {
            const container = document.getElementById('admin-gallery-list');
            const items = container.querySelectorAll('.admin-photo-item');
            items.forEach(el => {
                const id = el.dataset.id;
                window.selectedPhotoIds.add(id);
                el.classList.add('selected');
            });
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const btnDelete = document.getElementById('btn-delete-selected');
            const btnDeselect = document.getElementById('btn-deselect-all');
            const countSpan = document.getElementById('selected-count');
            const count = window.selectedPhotoIds.size;
            
            if (count > 0) {
                btnDelete.classList.remove('hidden');
                btnDeselect.classList.remove('hidden');
                countSpan.innerText = count;
            } else {
                btnDelete.classList.add('hidden');
                btnDeselect.classList.add('hidden');
            }
        }

        async function saveNewOrder() {
            const container = document.getElementById('admin-gallery-list');
            const items = container.querySelectorAll('.admin-photo-item');
            const batch = writeBatch(db);
            items.forEach((item, index) => {
                const id = item.dataset.id;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'gallery_images', id);
                batch.update(docRef, { order: index + 1 });
            });
            try { await batch.commit(); } catch(e) { console.error(e); }
        }

        window.deleteSelectedPhotos = async function() {
            const count = window.selectedPhotoIds.size;
            if (count === 0) return;
            if(confirm(`¬øConfirmas eliminar ${count} fotos?`)) {
                const batch = writeBatch(db);
                for (const id of window.selectedPhotoIds) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'gallery_images', id);
                    batch.delete(docRef);
                }
                try {
                    await batch.commit();
                    window.clearSelection(); 
                } catch(e) { alert("Error al borrar: " + e.message); }
            }
        }

        window.handleFileSelect = function() {
            const input = document.getElementById('file-input');
            const files = input.files;
            const queueDiv = document.getElementById('upload-queue');
            const btn = document.getElementById('upload-btn');
            if(files.length > 0) {
                btn.classList.remove('hidden');
                btn.disabled = false;
                btn.innerText = `SUBIR ${files.length} FOTO(S)`;
                queueDiv.classList.remove('hidden');
                let listHtml = '';
                for(let i=0; i<Math.min(files.length, 5); i++) listHtml += `<div class="truncate">‚Ä¢ ${files[i].name}</div>`;
                if(files.length > 5) listHtml += `<div>... y ${files.length - 5} m√°s.</div>`;
                queueDiv.innerHTML = listHtml;
            }
        }

        window.uploadPhotos = async function() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            if (files.length === 0) return;
            
            const btn = document.getElementById('upload-btn');
            const progressBar = document.getElementById('upload-progress');
            const progressText = document.getElementById('progress-text');
            const progressContainer = document.getElementById('upload-progress-container');

            btn.disabled = true;
            progressContainer.classList.remove('hidden');
            let uploadedCount = 0;
            const totalFiles = files.length;

            for (let i = 0; i < totalFiles; i++) {
                try {
                    const base64 = await compressImage(files[i]);
                    const newOrder = window.allPhotos.length + uploadedCount + 1;
                    await addDoc(photosRef, {
                        url: base64,
                        order: newOrder,
                        views: 0,
                        downloads: 0,
                        timestamp: serverTimestamp()
                    });
                    uploadedCount++;
                    const percent = Math.round((uploadedCount / totalFiles) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressText.innerText = `${percent}%`;
                } catch (err) { console.error(err); }
            }

            setTimeout(() => {
                progressContainer.classList.add('hidden');
                btn.disabled = false;
                fileInput.value = ""; 
                document.getElementById('upload-queue').classList.add('hidden');
                btn.classList.add('hidden');
            }, 1000);
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = (e) => reject(e);
                };
                reader.onerror = (e) => reject(e);
            });
        }

        // Inicializar UI Estrellas y Confetti
        const starsContainer = document.getElementById('stars-container');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.width = `${Math.random() * 2 + 1}px`;
            star.style.height = star.style.width;
            star.style.setProperty('--duration', `${Math.random() * 1 + 0.5}s`);
            starsContainer.appendChild(star);
        }

        function launchConfetti() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#74c045', '#6b3fa0', '#ffffff'] });
        }
    </script>
</body>
</html>